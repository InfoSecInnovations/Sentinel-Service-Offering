{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "templateSpecs_isi_spec_name": {
          "defaultValue": "isi-spec",
          "type": "String"
      }
  },
  "variables": {},
  "resources": [
      {
          "type": "Microsoft.Resources/templateSpecs",
          "apiVersion": "2022-02-01",
          "name": "[parameters('templateSpecs_isi_spec_name')]",
          "location": "westeurope",
          "properties": {}
      },
      {
          "type": "Microsoft.Resources/templateSpecs/versions",
          "apiVersion": "2022-02-01",
          "name": "[concat(parameters('templateSpecs_isi_spec_name'), '/1')]",
          "location": "westeurope",
          "dependsOn": [
              "[resourceId('Microsoft.Resources/templateSpecs', parameters('templateSpecs_isi_spec_name'))]"
          ],
          "properties": {
              "uiFormDefinition": {
                  "uri": "https://raw.githubusercontent.com/InfoSecInnovations/Sentinel-Service-Offering/main/arm-templates/input-form-test.json"
              },
              "mainTemplate": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0", 
                  "parameters": {
                      "workspaceName": {
                          "type": "string",
                          "defaultValue": "LAW-ISI-Default",
                          "metadata": {
                              "description": "Name for the Log Analytics workspace used to aggregate data"
                          }
                      },
                      "pricingTier": {
                          "type": "string",
                          "allowedValues": [
                              "PerGB2018",
                              "Free",
                              "Standalone",
                              "PerNode",
                              "Standard",
                              "Premium"
                          ],
                          "defaultValue": "PerGB2018",
                          "metadata": {
                              "description": "Pricing tier: pergb2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
                          }
                      },
                      "dataRetention": {
                          "type": "int",
                          "defaultValue": 30,
                          "minValue": 7,
                          "maxValue": 730,
                          "metadata": {
                              "description": "Number of days of retention. Workspaces in the legacy Free pricing tier can only have 7 days."
                          }
                      },
                      "immediatePurgeDataOn30Days": {
                          "type": "bool",
                          "defaultValue": true,
                          "metadata": {
                              "description": "If set to true when changing retention to 30 days, older data will be immediately deleted. Use this with extreme caution. This only applies when retention is being set to 30 days."
                          }
                      },
                      "enableOffice365": {
                          "type": "bool",
                          "defaultValue": false,
                          "metadata": {
                              "description": "You should enable this if you use Office 365 to get the appropriate logs and workspaces."
                          }
                      },
                      "exchangeState": {
                          "type": "string",
                          "defaultValue": "test"
                      },
                      "sharepointState": {
                          "type": "string",
                          "defaultValue": "test"
                      },
                      "teamsState": {
                          "type": "string",
                          "defaultValue": "test"
                      },
                      "securityCollectionTier": {
                          "type": "string",
                          "metadata": {
                              "description": "Tier for gathering Windows Security Events."
                          },
                          "allowedValues": [
                              "All",
                              "Recommended",
                              "Minimal",
                              "None"
                          ],
                          "defaultValue": "Minimal"
                      },
                      "location": {
                          "type": "string",
                          "defaultValue": "[[resourceGroup().location]",
                          "metadata": {
                              "description": "Location for all resources."
                          }
                      }
                  },
                  "variables": {
                      "isiSentinel": "https://raw.githubusercontent.com/InfoSecInnovations/Sentinel-Service-Offering/main/"
                  },
                  "resources": [
                      {
                          "name": "deployAzureSentinel",
                          "type": "Microsoft.Resources/deployments",
                          "apiVersion": "2022-09-01",
                          "properties": {
                              "mode": "Incremental",
                              "expressionEvaluationOptions": {
                                "scope": "inner"
                              },
                              "templateLink": {
                                  "uri": "[[uri(variables('isiSentinel'),'arm-templates/isi-main.json')]",
                                  "contentVersion": "1.0.0.0"
                              },
                              "parameters": {
                                  "workspaceName": {
                                      "value": "[[parameters('workspaceName')]"
                                  },
                                  "pricingTier": {
                                      "value": "[[parameters('pricingTier')]"
                                  },
                                  "dataRetention": {
                                      "value": "[[parameters('dataRetention')]"
                                  },
                                  "immediatePurgeDataOn30Days": {
                                      "value": "[[parameters('immediatePurgeDataOn30Days')]"
                                  },
                                  "location": {
                                      "value": "[[parameters('location')]"
                                  },
                                  "enableOffice365": {
                                    "value": "[[parameters('enableOffice365')]"
                                  },
                                  "exchangeState": {
                                    "value": "[[parameters('exchangeState')]"
                                  },
                                  "sharepointState": {
                                    "value": "[[parameters('sharepointState')]"
                                  },
                                  "teamsState": {
                                    "value": "[[parameters('teamsState')]"
                                  },
                                  "securityCollectionTier": {
                                    "value": "[[parameters('securityCollectionTier')]"
                                  }
                              }
                          }
                      }
                  ]             
              }
          }
      }
  ]
}