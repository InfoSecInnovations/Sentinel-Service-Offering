{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "enableCritical": {
      "type": "bool"
    },
    "enableWarning": {
      "type": "bool"
    },
    "enableVerbose": {
      "type": "bool"
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "workspaceName": {
      "type": "string"
    },
    "workspaceId": {
      "type": "string"
    }
  },
  "variables": {
    "artifactsAzureSentinel2Go": "https://raw.githubusercontent.com/InfoSecInnovations/Microsoft-Sentinel2Go/master/",
    "emptyArray": [],
    "enabledLevels": "[concat(if(parameters('enableCritical'), createArray(1), variables('emptyArray')), if(parameters('enableWarning'), createArray(2), variables('emptyArray')), if(parameters('enableVerbose'), createArray(3), variables('emptyArray')))]",
    "xPath": "[format('System!*[System[({0})]]', join(map(variables('enabledLevels'), lambda('level', format('Level=${0}', lambdaVariables('level')))), ' or '))]",
    "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
  },
  "resources": [
    {
      "name": "deployDCR",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[uri(variables('artifactsAzureSentinel2Go'),'microsoft-sentinel/linkedtemplates/data-collection-rules/creation-azureresource.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "ruleName": {
            "value":  "DCR-AMA-Logs-Security-Events"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "dataSources": {
            "value": {
              "windowsEventLogs": [ 
                { 
                  "name": "eventLogsDataSource", 
                  "scheduledTransferPeriod": "PT5M", 
                  "streams": [ 
                    "Microsoft-SecurityEvent" 
                  ], 
                  "xPathQueries": [ 
                    "[variables('xPath')]" 
                  ] 
                } 
              ] 
            }
          },
          "destinations": {
            "value": { 
              "logAnalytics": [ 
                { 
                  "name": "SecurityEvent", 
                  "workspaceId": "[parameters('workspaceId')]", 
                  "workspaceResourceId": "[variables('workspaceResourceId')]"
                } 
              ] 
            }
          }, 
          "dataFlows": {
            "value": [ 
              { 
                "streams": [ 
                  "Microsoft-SecurityEvent" 
                ], 
                "destinations": [ 
                  "SecurityEvent" 
                ] 
              } 
            ]
          },
          "tagsArray": {
            "value": {}
          } 
        }
      }
    }
  ]
}